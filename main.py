
# ----------------------------------------------------------------------------
# Imports 
# ----------------------------------------------------------------------------
from ngram_preprocessor import NgramPreprocessor
from detector import MalwareDetector
from pe_header_preprocessor import PeHeaderPreprocessor
from apk_preprocessor import APKPreprocessor
import logging
import sys

# ----------------------------------------------------------------------------
# Globals
# ----------------------------------------------------------------------------

FEATURES_COUNT_NGRAM_MODEL = 230
FEATURES_COUNT_PE_HEADERS_MODEL = 110

FEATURES_COUNT_ANDROID_PERMISSIONS = 70


# ----------------------------------------------------------------------------
# Functions 
# ----------------------------------------------------------------------------

def setup_logger():
	logging.getLogger().setLevel(logging.DEBUG)

	output_file_handler = logging.FileHandler("logs.log", 'w')
	stdout_handler = logging.StreamHandler(sys.stdout)
	
	formatter = logging.Formatter("%(asctime)s - %(name)s - %(levelname)s - %(funcName)s - %(message)s",  datefmt='%d-%m-%Y- %H:%M:%S')
	output_file_handler.setFormatter(formatter)
	stdout_handler.setFormatter(formatter)

	logging.getLogger().addHandler(output_file_handler)
	logging.getLogger().addHandler(stdout_handler)



def main_ngram():
	DATASET_PATH = 'output-datasets\\dikes_dataset_ngram.csv'

	preprocessor = NgramPreprocessor(FEATURES_COUNT_NGRAM_MODEL)
	detector = MalwareDetector(FEATURES_COUNT_NGRAM_MODEL)

	preprocessor.process_all_files_in_dir('in-files\\benign', 'out-files\\benign', 'exe')
	preprocessor.process_all_files_in_dir('in-files\\malwares', 'out-files\\malwares', 'exe')

	preprocessor.extract_most_common_sequences('out-files\\malwares', 'most_common_sequences.csv')
	preprocessor.create_dataset('most_common_sequences.csv', 'out-files\\benign', 'out-files\\malwares', DATASET_PATH)
	
	detector.test_train_dataset(DATASET_PATH, 'RF')
	detector.test_train_dataset(DATASET_PATH, 'KNN')
	detector.test_train_dataset(DATASET_PATH, 'LR')
	detector.test_train_dataset(DATASET_PATH, 'SVM')


def main_pe_headers():
	DATASET_PATH = 'output-datasets\\dike_dataset_pe_headers_110.csv'

	preprocessor = PeHeaderPreprocessor(FEATURES_COUNT_PE_HEADERS_MODEL)
	detector = MalwareDetector(FEATURES_COUNT_PE_HEADERS_MODEL)

	preprocessor.extract_most_common_api_functions_used('in-files\\test' , 'most_used_api_functions.csv')
	preprocessor.create_dataset('most_used_api_functions.csv', 'in-files\\test', 'in-files\\test2', DATASET_PATH)

	detector.test_train_dataset(DATASET_PATH, 'RF')
	detector.test_train_dataset(DATASET_PATH, 'KNN')
	detector.test_train_dataset(DATASET_PATH, 'LR')
	detector.test_train_dataset(DATASET_PATH, 'SVM')


def main_apks():
	DATASET_PATH = 'output-datasets\\apk_dataset_banking_70.csv'

	preprocessor = APKPreprocessor(FEATURES_COUNT_ANDROID_PERMISSIONS)
	detector = MalwareDetector(FEATURES_COUNT_ANDROID_PERMISSIONS)

	preprocessor.extract_most_common_api_functions_used('in-files\\android_malware\\Banking' , 'banking_permissions.csv')
	preprocessor.create_dataset('banking_permissions.csv', 'in-files\\android_benign', 'in-files\\android_malware\\Banking', DATASET_PATH)

	detector.test_train_dataset(DATASET_PATH, 'RF')
	detector.test_train_dataset(DATASET_PATH, 'KNN')
	detector.test_train_dataset(DATASET_PATH, 'LR')
	detector.test_train_dataset(DATASET_PATH, 'SVM')





def main():
	setup_logger()
	logging.getLogger().debug('START')

	main_apks()
	



if __name__ == '__main__':
	main()



"""
	
	N = 2

** TO EXTRACT FROM CSV:
	ngram_mat = np.genfromtxt('Teams.exe-ngram.csv' ,skip_header=True, dtype=str, delimiter=',')
	tfs =ngram_mat[:,N].astype(np.int32)
	opcodes = ngram_mat[:,0:N]


"""